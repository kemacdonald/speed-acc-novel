---
title: "Speed-Acc-Novel Shifts Analysis"
output: html_document
---

## Set up

```{r chunk_options, echo = F}
# set some global options
knitr::opts_chunk$set(warning=F, message=F, sanitize = T, 
                      fig.height=4, fig.width=8, echo=T, cache = F)
```

Libraries and data paths
```{r}
library(here)
library(tidyverse)
library(knitr)
# source(here::here("code/helper_functions/libraries_and_functions.R"))
data_path <- "data/03_processed_data/"
theme_set(ggthemes::theme_base())
```

Read in data
```{r}
d <- read_csv(here::here(data_path, "speed_acc_novel_shifts.csv"))
View(d)
```

## Check the data

Some questions we'd like to know about our data:

  * how many participants total? 
  * how many adults vs. kids? boys vs. girls:
  * how many participants in each age group?
  * how many participants were in the pilot, drop, or keep categories?
  * how many trials from each participant? for each word? for each gaze type?

We can answer these questions using tidyverse to generate tables. For example, the following code uses the `count()` function to tell us how many rows (i.e., trials) each particpant has in the dataset. `kable()` is a function for making the tables prettier if we were to knit this document to an html file for viewing on a browser.

Participant number and number trials
```{r}
d %>% 
  count(subid) %>% 
  kable()
```

Number of unique participants
```{r}
d$subid %>%
  unique %>%
  length
```

Add age group
```{r}
d$age_group <- substr(d$age, 0, 1)
```

Group by demographics
```{r}
d_by_subject <- d %>%
  group_by(subid, gender, ethnicity_race, order_key, keep_drop, reason_excluded, age, age_group, age_category) %>%
  summarise
View(d_by_subject)
# missing demographic info for SAN-071718-02/02b
# what happened to age_group?
```

Gender breakdown
```{r}
d_by_subject %>%
  group_by(gender) %>%
  count(gender)
```

Adults vs. children
```{r}
d_by_subject %>%
  group_by(age_category) %>%
  count(age_category)
```

Age group breakdown
```{r}
d_by_subject %>%
  group_by(age_group) %>%
  count(age_group)
```

Count the number of participants who are kept and dropped
```{r}
d_by_subject %>%
  group_by(keep_drop) %>%
  count(keep_drop)

d_by_subject %>%
  group_by(reason_excluded) %>%
  count(reason_excluded)
```

Count the number of trials per participant
```{r}
d %>%
  group_by(subid) %>%
  count(subid)
```

Count the number of trials per word
```{r}
d %>%
  group_by(noun) %>%
  count(noun)
```

Count the number of trials per word per participant
```{r}
d %>%
  group_by(subid, noun) %>%
  count(subid)
```

Trials per gaze condition per participant:
Here is some code that uses `group_by()` to tells us how many trials are in each condition. Note the use of `arrange()` to keep the table sorted by participant id.

```{r}
d %>% 
  group_by(gaze_condition) %>% 
  count(subid) %>% 
  arrange(subid) %>% 
  kable

```

Count trials per gaze condition
```{r}
d %>%
  group_by(gaze_condition) %>%
  count(gaze_condition)
```


## Filter data

Remove shifts that do not start at center. Remove participants based on keep_drop, and extreme RTs

*Note that if you want to analyze the full data set you should comment out the first filter step. only run this if you want to JUST use pilot data!

Take out word blocks for reasons explained in subject log or if there is data for less than 50% of word block:
```{r}
d_complete <- d %>%
  filter(is.na(block_excluded) | 
           block_excluded != learning_block) %>%
  group_by(subid, learning_block) %>%
  filter(n() >= 4)
# should probably combine this with next filtering step
```


Filter data based on keep_drop and center start locations:
```{r}
d_keep <- d_complete %>%
  filter(keep_drop == "keep", 
         shift_start_location == "center") %>%
  group_by(subid) %>%
  filter(n() >= 16)
```

If I wanted to look at ONLY pilot data:
```{r, eval = FALSE}
d_keep <- d %>%
  filter(reason_excluded == "pilot",
         shift_start_location == "center")
View(d_keep)
```



TODO: remove RTs that are +/- 3 standard deviations from the mean.

```{r, eval=FALSE}
# get mean RT and sd of RT
mean_rt <- ms$m %>%
  mean()
sd_rt <- ms$m %>%
  sd()

# define RT cut-offs
rt_lower_limit <- mean_rt - 3*sd_rt
rt_upper_limit <- mean_rt + 3*sd_rt

# filter out RTs outside cut-offs
ms_ss_FILTERED <- ms_ss %>%
  filter(m_ss > rt_lower_limit, m_ss < rt_upper_limit)
View(d_keep)

ms_FILTERED <- ms_ss_FILTERED %>%
  group_by(gaze_condition, 
           trial_type, 
           trial_num_learn_block) %>%
  summarise(m = mean(m_ss))
```

Count number of trials after filtering
```{r}
d_keep %>%
  count(gaze_condition, trial_type, trial_num_learn_block)
```

Summarise RT
```{r}
ms_ss <- d_keep %>%
  filter(!is.na(rt)) %>%
  filter(shift_accuracy == "correct") %>%
  group_by(subid, 
           age_category,
           gaze_condition, 
           trial_type, 
           trial_num_learn_block) %>%
  summarise(m_ss = mean(rt)) 

ms <- ms_ss %>%
  group_by(age_category,
           gaze_condition, 
           trial_type, 
           trial_num_learn_block) %>%
  summarise(m = mean(m_ss))
```

## Explore data using visualization

What does the distribution of age in the sample look like? 

Make a histogram of subjects' ages
```{r}
ggplot(data = d_by_subject) +
   geom_histogram(mapping = aes(x= age),
                  fill = "light blue",
                  color = "black",
                  binwidth = .2) +
  theme_minimal()
```

### Reaction Time 

What does the distribution of Reaction Times (RT) look like overall? How about across different gaze conditions?

Plot overall RT distribution
```{r}
ggplot(data = d_keep) +
  geom_density(mapping = aes(x = rt),
                 binwidth = .1,
                 fill = "light blue",
                 color = "black") +
  theme_minimal()
```


Plot RT density distributions by gaze condition in one graph
```{r}
ggplot(data = d_keep) +
  geom_density(mapping = aes(x = rt,
                             fill = gaze_condition),
               alpha = .5)+
  theme_minimal()
```


Plot RT distribution by gaze condition in exposure vs. test trials
```{r}
ggplot(data = d_keep) +
  geom_density(mapping = aes(x = rt,
                             fill = gaze_condition),
               alpha = .5) +
  theme_minimal() + 
  facet_wrap(facets = ~trial_type)
```


Plot RT as a function of trial number in different gaze conditions in exposure and test trials
```{r}
ggplot(data = ms) +
  geom_line(mapping = aes(x = trial_num_learn_block,
                          y = m,
                          color = gaze_condition)) +
  theme_minimal() +
  facet_wrap(facets = ~trial_type) +
  labs(x = "trial number", y = "mean RT")
```

Key: Plot RT over trial numbers for children and adults
```{r}
ggplot(data = ms) +
  geom_line(mapping = aes(x = trial_num_learn_block,
                          y = m,
                          color = gaze_condition)) +
  theme_minimal() +
  facet_grid(age_category ~ trial_type) +
  labs(x = "Trial number", 
       y = "Mean reaction time",
       title = "First shift reaction time") +
  theme(panel.border = element_rect(colour = "gray", fill=NA, size=1),
        text = element_text(size = 20))
```



### Accuracy

What does first shift accuracy look like for different gaze conditions?

Make a table for accuracy by condition and trial number
```{r}
# table for accuracy by condition
cond_acc <- d_keep %>%
  group_by(gaze_condition, 
           shift_accuracy, 
           trial_num_learn_block,
           trial_type,
           age_category) %>%
  count(shift_accuracy)

# spread out table
cond_acc_spread <- spread(cond_acc, key = shift_accuracy, value = n)

# change NAs to 0
cond_acc_spread[is.na(cond_acc_spread)] <- 0
# do NOT run this command when there is a "total" column in the data frame!

#compute proportion correct first shifts and add to df
cond_acc_spread <- cond_acc_spread %>%
  mutate(total = correct + incorrect,
         prop_correct = correct / total)
```

Plot accuracy as a function of trial number for all trials
```{r}
ggplot(data = cond_acc_spread) +
  geom_line(mapping = aes(x = trial_num_learn_block,
                          y = prop_correct,
                          color = gaze_condition)) +
  scale_y_continuous(limits = c(0, 1)) +
  theme_minimal() +
  facet_wrap(facets = ~trial_type, ~age_category) +
  labs(x = "trial number", 
       y = "proportion correct",
       title = "First shift accuracy")
```

Key: Plot first shift accuracy in exposure and test trials for adults vs children
```{r}
ggplot(data = cond_acc_spread) +
  geom_line(mapping = aes(x = trial_num_learn_block,
                          y = prop_correct,
                          color = gaze_condition)) +
  scale_y_continuous(limits = c(0, 1)) +
  facet_grid(age_category ~ trial_type) +
  labs(x = "Trial number", 
       y = "Proportion correct",
       title = "First shift accuracy") +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "gray", 
                                    fill=NA, 
                                    size=1),
        text = element_text(size=20)) +
  geom_hline(yintercept=.5, linetype="dotted", size = 1)
```

Make table for accuracy for children based on age group:
```{r}
# table for accuracy by condition
cond_acc_age <- d_keep %>%
  filter(age_category == "child") %>%
  group_by(gaze_condition, 
           shift_accuracy, 
           trial_num_learn_block,
           trial_type,
           age_category,
           age_group) %>%
  count(shift_accuracy)

# spread out table
cond_acc_age_spread <- spread(cond_acc_age, key = shift_accuracy, value = n)

# change NAs to 0
cond_acc_age_spread[is.na(cond_acc_age_spread)] <- 0
# do NOT run this command when there is a "total" column in the data frame!

#compute proportion correct first shifts and add to df
cond_acc_age_spread <- cond_acc_age_spread %>%
  mutate(total = correct + incorrect,
         prop_correct = correct / total)
```

Plot accuracy over trials for children based on age group:
```{r}
ggplot(data = cond_acc_age_spread) +
  geom_line(mapping = aes(x = trial_num_learn_block,
                          y = prop_correct,
                          color = gaze_condition)) +
  scale_y_continuous(limits = c(0, 1)) +
  facet_grid(age_group ~ trial_type) +
  labs(x = "Trial number", 
       y = "Proportion correct",
       title = "First shift accuracy") +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "gray", 
                                    fill=NA, 
                                    size=1),
        text = element_text(size=10)) +
  geom_hline(yintercept=.5, linetype="dotted", size = 1)
```

Table for overall accuracy for children in exposure and test trials based on age group
```{r}
# remake cond acc table without trial number
cond_acc_age_collapsed <- d_keep %>%
  filter(age_category == "child") %>%
  group_by(age_group,
           shift_accuracy,
           gaze_condition,
           trial_type) %>%
  count(shift_accuracy)

# spread out table
cond_acc_age_coll_spread <- spread(cond_acc_age_collapsed, key = shift_accuracy, value = n)

# change NAs to 0
cond_acc_age_coll_spread[is.na(cond_acc_age_coll_spread)] <- 0
# do NOT run this command when there is a "total" column in the data frame!

#compute proportion correct first shifts and add to df
cond_acc_age_coll_spread <- cond_acc_age_coll_spread %>%
  mutate(total = correct + incorrect,
         prop_correct = correct / total)
```

Plot overall accuracy for children in only test trials based on age group
```{r}
cond_acc_age_test_coll <- cond_acc_age_coll_spread %>%
  filter(trial_type == "test")
```

Plot overall accuracy for children in exposure and test trials based on age group
```{r}
ggplot(data = cond_acc_age_coll_spread) +
  geom_bar(mapping = aes(x = age_group,
                         y = prop_correct,
                         fill = gaze_condition),
           stat = "identity",
           position = "dodge") +
  scale_y_continuous(limits = c(0, 1)) +
  labs(x = "age group",
       y = "prop correct") +
  facet_wrap(~trial_type)
```








Ignore all this!









Filter data by gaze condition (not sure if I'll need this but might as well keep):
```{r pull-out-data-by-gaze-condition}
d_keep_gaze <- d_keep %>%
  filter(gaze_condition == "gaze")

d_keep_sa <- d_keep %>%
  filter(gaze_condition == "straight_ahead")
```

Accuracy by condition and trial number by participant (attempt)
```{r, eval = FALSE}
# table for accuracy by condition
condition_accuracy_2 <- d_keep %>%
  group_by(subid,
           age_category,
           gaze_condition, 
           shift_accuracy, 
           trial_num_learn_block,
           trial_type) %>%
  count(shift_accuracy)

condition_accuracy_spread_2 <- spread(condition_accuracy_2, key = shift_accuracy, value = n)
condition_accuracy_spread_2 <- condition_accuracy_spread_2 %>%
  mutate(total = correct + incorrect,
         prop_correct = correct / total)

condition_accuracy_spread_2[is.na(condition_accuracy_spread_2)] <- 0

condition_accuracy_spread_total_2 <- condition_accuracy_spread_2 %>%
  group_by(age_category,
           gaze_condition,
           trial_num_learn_block,
           trial_type) %>%
  summarise(m_prop_correct = mean(prop_correct))

ggplot(data = condition_accuracy_spread_total_2) +
  geom_line(mapping = aes(x = trial_num_learn_block,
                          y = m_prop_correct,
                          color = gaze_condition)) +
  scale_y_continuous(limits = c(0, 1)) +
  theme_minimal() +
  facet_grid(age_category ~ trial_type) +
  labs(x = "trial number", y = "proportion correct")
```





Accuracy by condition and trial number for just test trials
```{r table-accuracy-condition-trial-number-test-trials, eval = FALSE}
# table for accuracy by condition on just test trials
d_keep_test <- d_keep %>%
  filter(trial_type == "test")

condition_accuracy_test <- d_keep_test %>%
  group_by(gaze_condition, 
           shift_accuracy,
           trial_num_learn_block) %>%
  count(gaze_condition)

condition_accuracy_spread_test <- spread(condition_accuracy_test, key = shift_accuracy, value = n)
condition_accuracy_spread_test <- condition_accuracy_spread_test %>%
  mutate(total = correct + incorrect,
         prop_correct = correct / total)

# bar graph of accuracy on test trials by condition
ggplot(data = condition_accuracy_spread_test) +
  geom_bar(mapping = aes(x = gaze_condition,
                         y = prop_correct),
           stat = "identity",
           fill = "light blue") +
  theme_minimal() +
  labs(x = "trial number", y = "proportion correct")

# plot accuracy as function of trial number on just test trials
ggplot(data = condition_accuracy_spread_test) +
  geom_line(mapping = aes(x = trial_num_learn_block,
                          y = prop_correct,
                          color = gaze_condition)) +
  scale_y_continuous(limits = c(0, 1)) +
  theme_minimal()
```




Earlier attempts to plot accuracy:
```{r, eval = FALSE}
# this is probably trash
ggplot(data = d_keep) +
  geom_bar(mapping = aes(x = gaze_condition,
                         y = shift_accuracy,
                         fill = shift_accuracy),
           position = position_fill(),
           stat = "identity") +
  theme_minimal()

ggplot(data = d_keep) +
  geom_bar(mapping = aes(x = gaze_condition,
                         fill = shift_accuracy),
           stat = "count") +
  theme_minimal()
# end of trash

# plot proportion of correct and incorrect shifts by condition
ggplot(data = d_keep) +
  geom_bar(mapping = aes(x = gaze_condition,
                         fill = factor(shift_accuracy)),
           position = position_fill(reverse = TRUE)) +
  theme_minimal()

ggplot(data = condition_accuracy) +
  geom_bar(mapping = aes(x = gaze_condition,
                         y = ))

```

Bar graph to show proportion correct for each gaze condition
```{r bar-graph-proportion-correct-by-condition}
ggplot(data = condition_accuracy_spread) +
  geom_bar(mapping = aes(x = gaze_condition,
                         y = prop_correct),
           stat = "identity",
           fill = "light blue") +
  theme_minimal()
```

Plot RT density distributions by gaze condition in separate graphs:
```{r plot-rt-by-gaze-condition-separate-graphs}
ggplot(data = d_keep) +
  geom_density(mapping = aes(x = rt),
                 binwidth = .1,
                 fill = "light blue",
                 color = "black") +
  theme_minimal() +
  facet_wrap(facets = ~gaze_condition)
```
