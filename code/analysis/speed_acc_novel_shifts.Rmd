---
title: "Speed-Acc-Novel Shifts Analysis"
output: html_document
---

## Set up

```{r chunk_options, echo = F}
# set some global options
knitr::opts_chunk$set(warning=F, message=F, sanitize = T, fig.height=4, fig.width=8, echo=T, cache = F)
```

Libraries and data paths:
```{r}
library(here)
library(tidyverse)
library(knitr)
# source(here::here("code/helper_functions/libraries_and_functions.R"))
data_path <- "data/03_processed_data/"
theme_set(ggthemes::theme_base())
```

Read in data:
```{r}
d <- read_csv(here::here(data_path, "speed_acc_novel_shifts.csv"))
View(d)
```

## Check the data

Some questions we'd like to know about our data:

  * how many participants total? 
  * how many adults vs. kids? boys vs. girls:
  * how many participants in each age group?
  * how many participants were in the pilot, drop, or keep categories?
  * how many trials from each participant? for each word? for each gaze type?

### Basic Participant Info

Participant number and number trials:
```{r}
d %>% 
  count(subid) %>% 
  kable()
```

Number of unique participants:
```{r}
d$subid %>%
  unique() %>%
  length() %>%
  kable()
```

Add column for age group:
```{r}
d$age_group <- substr(d$age, 0, 1)
```

Group by demographics:
```{r}
d_by_subject <- d %>%
  group_by(subid, 
           gender, 
           age,
           age_group,
           age_category,
           ethnicity_race,
           keep_drop, 
           reason_excluded,
           order_key,
           order_number) %>%
  summarise()
View(d_by_subject)
# missing demographic info for SAN-071718-02/02b
# what happened to age_group?
```

Gender breakdown:
```{r}
d_by_subject %>%
  group_by(gender) %>%
  count(gender) %>%
  kable()
```

Number of adults and children:
```{r}
d_by_subject %>%
  group_by(age_category) %>%
  count(age_category) %>%
  kable()
```

Age group breakdown:
```{r}
d_by_subject %>%
  group_by(age_group) %>%
  filter(keep_drop == "keep") %>%
  count(age_group) %>%
  kable()

# number of trials by age group
d_keep %>% 
  group_by(age_group) %>%
  count(age_group) %>%
  kable()
```

Count number of participants kept and dropped:
```{r}
d_by_subject %>%
  group_by(keep_drop) %>%
  count(keep_drop) %>%
  kable()

# see why they were dropped
d_by_subject %>%
  group_by(reason_excluded) %>%
  count(reason_excluded) %>%
  kable()
```

### Trial Numbers

Count number of children per order:
```{r}
d_by_subject %>%
  group_by(order_key) %>%
  count(order_key) %>%
  kable()
```

Count number of trials per participant:
```{r}
d %>%
  group_by(subid) %>%
  count(subid) %>%
  kable()
```

Count number of trials per word:
```{r}
d %>%
  group_by(noun) %>%
  count(noun) %>%
  kable()
```

Count number of trials per word per participant:
```{r}
d %>%
  group_by(subid, 
           noun) %>%
  count(subid) %>%
  kable()
```

Count number of trials per gaze condition per participant:
```{r}
d %>% 
  group_by(gaze_condition) %>% 
  count(subid) %>% 
  arrange(subid) %>% 
  kable()
```

Count number of trials per gaze condition:
```{r}
d %>%
  group_by(gaze_condition) %>%
  count(gaze_condition) %>%
  kable()
```

Count number of trials per order:
```{r}
d %>%
  group_by(order_key) %>%
  count(order_key) %>%
  kable()
```

## Filter data

Take out word blocks for reasons explained in subject log or if there is data for less than 50% of trials or less than 50% of word block:
```{r}
d_complete <- d %>%
  filter(is.na(block_excluded) | 
           block_excluded != learning_block) %>%
  group_by(subid) %>%
  filter(n() >= 16) %>%
  group_by(subid, 
           learning_block) %>%
  filter(n() >= 4)
# should probably combine this with next filtering step
```

Filter data based on keep_drop and center start locations:
```{r}
d_keep <- d_complete %>%
  filter(keep_drop == "keep")

d_keep_center <- d_keep %>%
  filter(shift_start_location == "center")
```

If I wanted to look at ONLY pilot data:
```{r, eval = FALSE}
d_keep <- d %>%
  filter(reason_excluded == "pilot",
         shift_start_location == "center")
View(d_keep)
```

Count number of trials after filtering:
```{r}
d_keep %>%
  group_by(gaze_condition,
           trial_type,
           trial_num_learn_block) %>%
  count(gaze_condition, 
        trial_type, 
        trial_num_learn_block) %>%
  kable()
```

Summarise RT:
```{r}
ms_ss <- d_keep %>%
  filter(!is.na(rt)) %>%
  filter(shift_accuracy == "correct") %>%
  group_by(subid, 
           age_category,
           gaze_condition, 
           trial_type, 
           trial_num_learn_block) %>%
  summarise(m_ss = mean(rt)) 

ms <- ms_ss %>%
  group_by(age_category,
           gaze_condition, 
           trial_type, 
           trial_num_learn_block) %>%
  summarise(m = mean(m_ss))
```


## Explore data using visualization

What does the distribution of age in the sample look like? 

Make a histogram of subjects' ages:
```{r}
ggplot(data = d_by_subject) +
   geom_histogram(mapping = aes(x = age),
                  fill = "light blue",
                  color = "black",
                  binwidth = .2) +
  theme_minimal()
```


### Reaction Time 

What does the distribution of Reaction Times (RT) look like overall? How about across different gaze conditions?

Plot overall RT distribution:
```{r}
# first, pull out correct first shifts
d_keep_correct <- d_keep %>%
  filter(shift_accuracy == "correct")

ggplot(data = d_keep_correct) +
  geom_density(mapping = aes(x = rt),
                 fill = "light blue",
                 color = "black") +
  theme_minimal()
```

Plot RT density distributions by gaze condition:
```{r}
ggplot(data = d_keep_correct) +
  geom_density(mapping = aes(x = rt,
                             fill = gaze_condition),
               alpha = .5)+
  theme_minimal()
```

Plot RT distribution by gaze condition in exposure vs. test trials:
```{r}
ggplot(data = d_keep_correct) +
  geom_density(mapping = aes(x = rt,
                             fill = gaze_condition),
               alpha = .5) +
  facet_wrap(facets = ~trial_type) +
  theme_minimal()
```

Key: Plot RT over trial numbers for children and adults:
```{r}
ggplot(data = ms) +
  geom_line(mapping = aes(x = trial_num_learn_block,
                          y = m,
                          color = gaze_condition)) +
  facet_grid(age_category ~ trial_type) +
  labs(x = "Trial number", 
       y = "Mean reaction time",
       title = "First shift reaction time") +
  theme_minimal() +
  theme(panel.border = element_rect(color = "gray", 
                                    fill = NA, 
                                    size = 1),
        text = element_text(size = 14))
```


### Accuracy

What does first shift accuracy look like for different gaze conditions?

Make a table for accuracy by condition and trial number over trials:
```{r}
# table for accuracy by condition
cond_acc <- d_keep_center %>%
  group_by(gaze_condition, 
           shift_accuracy, 
           trial_num_learn_block,
           trial_type,
           age_category) %>%
  count(shift_accuracy)

# spread out table
cond_acc_spread <- spread(cond_acc, 
                          key = shift_accuracy, 
                          value = n)

# change NAs to 0
cond_acc_spread[is.na(cond_acc_spread)] <- 0
# do NOT run this command when there is a "total" column in the data frame!

#compute proportion correct first shifts and add to df
cond_acc_spread <- cond_acc_spread %>%
  mutate(total = correct + incorrect,
         prop_correct = correct / total)
```

Key: Plot first shift accuracy in exposure and test trials for adults vs children over trials:
```{r}
ggplot(data = cond_acc_spread) +
  geom_line(mapping = aes(x = trial_num_learn_block,
                          y = prop_correct,
                          color = gaze_condition)) +
  facet_grid(age_category ~ trial_type) +
  geom_hline(yintercept = .5, 
             linetype ="dotted", 
             size = 1) +
  scale_y_continuous(limits = c(0, 1)) +
  labs(x = "Trial number", 
       y = "Proportion correct",
       title = "First shift accuracy") +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "gray", 
                                    fill = NA, 
                                    size = 1),
        text = element_text(size = 14))
```


### Age and Accuracy

Make table for children's overall accuracy based on age group:
```{r}
# make table for accuracy by condition and age group
cond_acc_age <- d_keep_center %>%
  filter(age_category == "child") %>%
  group_by(age_group,
           shift_accuracy,
           gaze_condition,
           trial_type) %>%
  count(shift_accuracy)

# spread out table
cond_acc_age_spread <- spread(cond_acc_age, key = shift_accuracy, value = n)

# change NAs to 0
cond_acc_age_spread[is.na(cond_acc_age_spread)] <- 0
# do NOT run this command when there is a "total" column in the data frame!

# compute proportion correct first shifts and add to df
cond_acc_age_spread <- cond_acc_age_spread %>%
  mutate(total = correct + incorrect,
         prop_correct = correct / total)
```

Plot children's overall accuracy based on age group:
```{r}
ggplot(data = cond_acc_age_coll_spread) +
  geom_bar(mapping = aes(x = age_group,
                         y = prop_correct,
                         fill = gaze_condition),
           stat = "identity",
           position = "dodge") +
  facet_wrap(~trial_type) +
  scale_y_continuous(limits = c(0, 1)) +
  labs(x = "age group",
       y = "prop correct",
       title = "Children's overall first shift accuracy by age group") +
  theme_minimal()
```

Make table for children's accuracy over trials based on age group:
```{r}
# remake cond acc age table with trial numbers
cond_acc_age_trials <- d_keep_center %>%
  filter(age_category == "child") %>%
  group_by(gaze_condition, 
           shift_accuracy, 
           trial_num_learn_block,
           trial_type,
           age_category,
           age_group) %>%
  count(shift_accuracy)

# spread out table
cond_acc_age_trials_spread <- spread(cond_acc_age_trials, 
                              key = shift_accuracy, 
                              value = n)

# change NAs to 0
cond_acc_age_trials_spread[is.na(cond_acc_age_trials_spread)] <- 0
# do NOT run this command when there is a "total" column in the data frame!

#compute proportion correct first shifts and add to table
cond_acc_age_trials_spread <- cond_acc_age_trials_spread %>%
  mutate(total = correct + incorrect,
         prop_correct = correct / total)
```

Plot children's accuracy over trials based on age group:
```{r}
ggplot(data = cond_acc_age_trials_spread) +
  geom_line(mapping = aes(x = trial_num_learn_block,
                          y = prop_correct,
                          color = gaze_condition)) +
  facet_grid(age_group ~ trial_type) +
  geom_hline(yintercept = .5, 
             linetype = "dotted", 
             size = 1) +
  scale_y_continuous(limits = c(0, 1)) +
  labs(x = "Trial number", 
       y = "Proportion correct",
       title = "Children's first shift accuracy by age group over trials") +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "gray", 
                                    fill = NA, 
                                    size = 1),
        text = element_text(size = 10))
```


### Order and Accuracy

Add order type column to d_keep_center:
```{r}
d_keep_center <- mutate(d_keep_center, 
                 order_type = 
                   if_else(order_key == "nogaze_gaze_gr_ol" | 
                             order_key == "nogaze_gaze_ol_gr", 
                           "nogaze_gaze", 
                           "gaze_nogaze"))
```

Make table for children's overall accuracy based on order:
```{r}
# make table for accuracy by condition and order
cond_acc_order <- d_keep_center %>%
  filter(age_category == "child") %>%
  group_by(gaze_condition, 
           shift_accuracy, 
           trial_type,
           order_type) %>%
  count(shift_accuracy)

# spread out table
cond_acc_order_spread <- spread(cond_acc_order, 
                                key = shift_accuracy, 
                                value = n)

# change NAs to 0
cond_acc_order_spread[is.na(cond_acc_order_spread)] <- 0
# do NOT run this command when there is a "total" column in the data frame!

#compute proportion correct first shifts and add to table
cond_acc_order_spread <- cond_acc_order_spread %>%
  mutate(total = correct + incorrect,
         prop_correct = correct / total)
```

Plot children's overall accuracy based on order:
```{r}
ggplot(data = cond_acc_order_spread) +
  geom_bar(mapping = aes(x = order_type,
                         y = prop_correct,
                         fill = gaze_condition),
           stat = "identity",
           position = "dodge") +
  facet_wrap(~trial_type) +
  scale_y_continuous(limits = c(0, 1)) +
  labs(x = "order type",
       y = "prop correct",
       title = "Children's overall first shift accuracy by order type") +
  theme_minimal() +
  theme(text = element_text(size = 10))
```

Make table for children's accuracy over trials based on order:
```{r}
# remake cond acc order table with trial numbers
cond_acc_order_trials <- d_keep_center %>%
  filter(age_category == "child") %>%
  group_by(gaze_condition, 
           shift_accuracy, 
           trial_type,
           order_type,
           trial_num_learn_block) %>%
  count(shift_accuracy)

# spread out table
cond_acc_order_trials_spread <- spread(cond_acc_order_trials, 
                                key = shift_accuracy, 
                                value = n)

# change NAs to 0
cond_acc_order_trials_spread[is.na(cond_acc_order_trials_spread)] <- 0
# do NOT run this command when there is a "total" column in the data frame!

#compute proportion correct first shifts and add to df
cond_acc_order_trials_spread <- cond_acc_order_trials_spread %>%
  mutate(total = correct + incorrect,
         prop_correct = correct / total)
```

Plot children's accuracy over trials based on order:
```{r}
ggplot(data = cond_acc_order_trials_spread) +
  geom_line(mapping = aes(x = trial_num_learn_block,
                          y = prop_correct,
                          color = gaze_condition)) +
  facet_grid(order_type ~ trial_type) +
  geom_hline(yintercept = .5, 
             linetype = "dotted", 
             size = 1) +
  scale_y_continuous(limits = c(0, 1)) +
  labs(x = "Trial number", 
       y = "Proportion correct",
       title = "Children's first shift accuracy by order type over trials") +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "gray", 
                                    fill = NA, 
                                    size = 1),
        text = element_text(size = 10))
```


### Looking to Speaker

Make table for proportion of shifts starting from center:
```{r}
# table for shifts by gaze condition
cond_acc_look_speaker <- d_keep %>%
  group_by(age_category,
           gaze_condition,
           shift_start_location,
           trial_type) %>%
  count(shift_start_location)
# note: took out shift accuracy

# spread out table
cond_acc_look_speaker_spread <- spread(cond_acc_look_speaker, 
                                key = shift_start_location, 
                                value = n)

# change NAs to 0
cond_acc_look_speaker_spread[is.na(cond_acc_look_speaker_spread)] <- 0
# do NOT run this command when there is a "total" column in the data frame!

#compute proportion correct first shifts and add to table
cond_acc_look_speaker_spread <- cond_acc_look_speaker_spread %>%
  mutate(total = center + not_center,
         prop_center = center / total)
```

Plot proportion of shifts starting from center by condition:
```{r}
ggplot(data = cond_acc_look_speaker_spread) +
  geom_bar(mapping = aes(x = gaze_condition,
                         y = prop_center),
           stat = "identity",
           fill = "light blue",
           position = "dodge") +
  facet_grid(age_category ~ trial_type) +
  scale_y_continuous(limits = c(0, 1)) +
  labs(x = "gaze condition",
       y = "prop looking to center",
       title = "Overall proportion looking to speaker at target noun onset") +
  theme_minimal() +
  theme(text = element_text(size = 10))
```

Make table for proportion of shifts starting from center over trials:
```{r}
# table for shifts by gaze condition
cond_acc_look_speaker_trials <- d_keep %>%
  group_by(age_category,
           gaze_condition,
           shift_start_location,
           trial_type,
           trial_num_learn_block) %>%
  count(shift_start_location)
# note: took out shift accuracy

# spread out table
cond_acc_look_speaker_trials_spread <- spread(cond_acc_look_speaker_trials, key = shift_start_location, value = n)

# change NAs to 0
cond_acc_look_speaker_trials_spread[is.na(cond_acc_look_speaker_trials_spread)] <- 0
# do NOT run this command when there is a "total" column in the data frame!

#compute proportion correct first shifts and add to table
cond_acc_look_speaker_trials_spread <- cond_acc_look_speaker_trials_spread %>%
  mutate(total = center + not_center,
         prop_center = center / total)
```

Plot proportion of shifts starting from center by condition over time:
```{r}
ggplot(data = cond_acc_look_speaker_trials_spread) +
  geom_line(mapping = aes(x = trial_num_learn_block,
                          y = prop_center,
                          color = gaze_condition)) +
  facet_grid(age_category ~ trial_type) +
  scale_y_continuous(limits = c(0, 1)) +
  labs(x = "Trial number", 
       y = "Proportion correct",
       title = "Proportion looking to speaker at target noun onset over trials") +
  theme_minimal() +
  theme(panel.border = element_rect(colour = "gray", 
                                    fill = NA, 
                                    size = 1),
        text = element_text(size = 10))
```