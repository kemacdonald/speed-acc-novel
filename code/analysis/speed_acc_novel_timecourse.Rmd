---
title: "Speed-Acc Novel Timecourse"
output: html_document
---

```{r chunk_options, echo = F}
knitr::opts_chunk$set(warning=F, message=F, sanitize = T, echo=T, cache = F)
```

## Set up

```{r}
source(here::here("code/helper_functions/libraries_and_functions.R"))
data_path <- "data/03_processed_data/"
theme_set(ggthemes::theme_base())
```

## Read data

```{r}
file_name <- "speed_acc_novel_timecourse.feather"
d <- read_feather(here::here(data_path, file_name)) 
```

Filter based on exlcusions in the subject log and remove bad blocks based on subject log.

```{r}
d_analysis <- d %>% 
  filter(keep_drop == "keep",
         t_rel_noun >= 0, 
         t_rel_noun <= 4
         )
```

Create time bins for each participant and each trial. Note that for the next chunk to work, you must filter the eye movement data to time after noun onset.

```{r}
d_analysis %<>% 
  split(.$subid) %>% 
  purrr::map_dfr(create_time_bins_ss, t_ms_diff = 33)
```

Create exclusions table.

```{r}
d %>% 
  distinct(subid, keep_drop, reason_excluded, age_category) %>% 
  filter(keep_drop == "drop") %>% 
  kable()
```

Create exclusions list based on number of trials completed.

```{r}
ss_exclude <- d_analysis %>%
  filter(target_looking != "away") %>% 
  distinct(subid, trial_num_exp) %>% 
  count(subid) %>% 
  filter(n < 16) %>% 
  pull(subid)
```

Filter participants who did not complete more than half the trials. 

```{r}
d_analysis %<>% filter(!(subid %in% ss_exclude))
```

Check how many trials in each block.

```{r}
d_analysis %>% 
  distinct(subid, trial_num_exp, learning_block, gaze_condition) %>% 
  count(subid, learning_block, gaze_condition) %>% 
  kable()
```

Make a table of proportion looking to each area of interest: Left, Right, Center, and Away

```{r}
d_analysis %>% 
  filter(!is.na(target_looking)) %>% 
  group_by(target_looking, age_category) %>% 
  summarise(count_looks = n()) %>% 
  group_by(age_category) %>% 
  mutate(total_looks = sum(count_looks),
         prop_looks = round(count_looks / total_looks, 2)) %>% 
  arrange(age_category) %>% 
  kable()
```

Filter away looks. 

```{r}
d_analysis %<>% filter(target_looking != "away")
```

## Visualize timecourse looking to all AOIs

Get means and CIs for proportion looking at each time slice for each participant

```{r}
ss_time <- aggregate_ss_looking(d_analysis, 
                           grouping_cols = list("subid", 
                                                "time_ms_normalized", 
                                                "gaze_condition", 
                                                "trial_type", 
                                                "age_category",
                                                "trial_num_learn_block"),
                           aoi_column = "target_looking") 


# Get means and CIs for proportion looking at each time slice collapsing across particpants
ms_time <- ss_time %>% 
  group_by(time_ms_normalized, 
           gaze_condition, 
           target_looking, 
           trial_type, 
           age_category,
           trial_num_learn_block) %>% 
  summarise(mean = mean(prop_looking), 
            n = n())
```

Make timecourse plot

```{r timecourse plot}
ms_time %>% 
  filter(age_category == "adults") %>% 
  ggplot(aes(x = time_ms_normalized, y = mean, 
           color = target_looking, linetype = gaze_condition)) + 
  lims(x = c(0, 4000), y = c(-.1, 1)) +
  geom_line(size = 1) +  
  guides(color = F) +
  labs(x = "Time in msec from onset of noun",
       y = "Proportion looking") +
  geom_dl(aes(label = target_looking), method = "last.bumpup") +
  facet_wrap(trial_num_learn_block~trial_type, ncol = 2) +
  ggthemes::theme_base() +
  ggthemes::scale_color_ptol() +
  theme(text = element_text(size = 12), legend.position = "top")
```

## Collapse and plot aggregate looking to target and disctracter

```{r}
ss_trial_number <- d_analysis %>% 
  filter(target_looking %in% c("target", "distracter")) %>% 
  aggregate_ss_looking(grouping_cols = list("subid", 
                                            "gaze_condition", 
                                            "trial_type", 
                                            "age_category",
                                            "trial_num_learn_block"),
                       aoi_column = "target_looking") 

ms_trial_number <- ss_trial_number %>% 
  group_by(gaze_condition, 
           target_looking, 
           trial_type, 
           trial_num_learn_block, 
           age_category) %>% 
  tidyboot::tidyboot_mean(column = prop_looking, nboot = 1000, na.rm = T)
```

Make key plot of target looking as a function of trial number and trial type.

```{r trial number plot}
ms_trial_number %>% 
  filter(target_looking == "target") %>% 
  ggplot(aes(x = trial_num_learn_block, y = mean, 
             lty = gaze_condition,
             color = gaze_condition,
             group = interaction(target_looking, gaze_condition))) +
  geom_pointrange(aes(ymin = ci_lower, ymax = ci_upper),
                  position = position_jitter(width = 0.09) ) +
  geom_line() +
  lims(y = c(0.3, 1.05)) +
  facet_wrap(trial_type~age_category) +
  geom_hline(yintercept = 0.5, lty = "dashed") +
  guides(lty = F) +
  ggthemes::scale_color_ptol() +
  theme(legend.position = "top")
```

## Collapse and plot target/distracter looking across conditions

```{r}
ss_cond <- d_analysis %>% 
  filter(target_looking %in% c("target", "distracter")) %>% 
  aggregate_ss_looking(grouping_cols = list("subid", 
                                            "gaze_condition", 
                                            "trial_type", 
                                            "age_category"),
                       aoi_column = "target_looking") 

ms_cond <- ss_cond %>% 
  group_by(gaze_condition, 
           target_looking, 
           trial_type, 
           age_category) %>% 
  tidyboot::tidyboot_mean(column = prop_looking, nboot = 1000, na.rm = T)
```

Plot

```{r}
ms_cond %>% 
  filter(target_looking == "target") %>% 
  ggplot(aes(x = fct_rev(age_category), y = mean, 
             color = gaze_condition)) +
  geom_pointrange(aes(ymin = ci_lower, ymax = ci_upper),
                  position = position_jitter(width = 0.15) ) +
  lims(y = c(0.3, 1.05)) +
  facet_wrap(~trial_type) +
  geom_hline(yintercept = 0.5, lty = "dashed") +
  ggthemes::scale_color_ptol() +
  theme(legend.position = "top")
```

## How does center looking change?

```{r}
ss_tr_center <- d_analysis %>% 
  aggregate_ss_looking(grouping_cols = list("subid", 
                                            "gaze_condition", 
                                            "trial_type", 
                                            "age_category",
                                            "trial_num_learn_block"),
                       aoi_column = "target_looking") 

ms_tr_center <- ss_tr_center %>% 
  group_by(gaze_condition, 
           target_looking, 
           trial_type, 
           trial_num_learn_block, 
           age_category) %>% 
  tidyboot::tidyboot_mean(column = prop_looking, nboot = 1000, na.rm = T)
```

```{r center trial number plot}
ms_tr_center %>% 
  filter(target_looking == "center") %>% 
  ggplot(aes(x = trial_num_learn_block, y = mean, 
             color = gaze_condition,
             group = interaction(target_looking, gaze_condition))) +
  geom_pointrange(aes(ymin = ci_lower, ymax = ci_upper),
                  position = position_jitter(width = 0.09) ) +
  geom_line() +
  lims(y = c(0, 1.05)) +
  facet_wrap(trial_type~age_category) +
  geom_hline(yintercept = 0.33, lty = "dashed") +
  guides(lty = F) +
  ggthemes::scale_color_ptol() +
  theme(legend.position = "top")
```

## Statistical models

```{r}

```

